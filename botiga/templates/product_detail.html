{% extends 'layouts/baseDetall.html' %}
{% load static %}

{% block content %}


<!-- 🥖 Breadcrumb (Historial de categorías) -->
<div class="container my-4">
    <div class="row">
        <div class="col-md-6 col-lg-6 d-flex product-images">
            <!-- Imagen grande (a la izquierda) -->
            <div class="d-flex me-4">
                {% if selected_variant.imatges.exists %}
                    <img src="{% static selected_variant.imatges.first.imatge %}" 
                         alt="{{ selected_variant.color }}" 
                         class="img-fluid rounded product-image" 
                         id="mainImage">
                {% else %}
                    <img src="{% static 'images/no-image.png' %}" 
                         alt="Sin imagen" 
                         class="img-fluid rounded product-image" 
                         id="mainImage">
                {% endif %}
            </div>
        
            <!-- Miniaturas en columna (a la derecha) -->
            <div class="d-flex flex-column">
                {% for image in imatges %}
                    <img src="{% static image.imatge %}" 
                         alt="{{ selected_variant.color }}" 
                         class="img-thumbnail mb-2 variant-thumbnail {% if forloop.first %}active{% endif %}" 
                         width="88" height="88" 
                         onclick="changeImage(event, this.src)">
                {% endfor %}
            </div>
        </div>
        
        

        <!-- ℹ️ Detalles del producto -->
        <div class="col-md-6 col-lg-5 d-flex flex-column justify-content-start ms-4 product-details">
            <h2 class="mb-3">{{ selected_variant.producte.nom_prod }}</h2>
            <p class="text-muted mb-4">{{ selected_variant.producte.descripcio }}</p>

            <!-- 💰 Precio y descuento -->
            <div class="mb-3">
                {% if selected_variant.descompte > 0 %}
                    <span class="h4 me-2 text-danger fw-bold" id="newPrice">{{ selected_variant.preu|floatformat:2 }}€</span>
                    <small id="oldPrice" class="text-muted text-decoration-line-through fs-6">{{ selected_variant.preu }}€</small>
                    <span id="discount" class="badge bg-success ms-2">{{ selected_variant.descompte }}% OFF</span>
                {% else %}
                    <span class="h4 me-2" id="newPrice">{{ selected_variant.preu|floatformat:2 }}€</span>
                {% endif %}
            </div>

            <!-- 🎨 Variantes (colores) -->
            <div class="mb-3">
                <h5>Selecciona una variant:</h5>
                <div class="d-flex flex-wrap">
                    {% for variant in variants %}
                        <img src="{% static variant.imatge %}" 
                            alt="{{ variant.color }}" 
                            class="img-thumbnail me-2 mb-2 variant-thumbnail {% if variant.id == selected_variant.id %}active{% endif %}" 
                            width="60" height="60"
                            data-variant-id="{{ variant.id }}"
                            onclick="changeVariant(event, '{{ variant.id }}')">
                    {% endfor %}
                </div>
            </div>

            <!-- 📏 Tallas -->
            <div class="mb-4 talla-container">
                <h5>Selecciona la teva talla:</h5>
                <form method="POST" action="{% url 'afegir_a_cistell' %}">
                    {% csrf_token %}
                    <input type="hidden" name="variant_id" value="{{ selected_variant.id }}">

                    <div class="btn-group mb-3" role="group">
                        {% for stock in stocks %}
                            {% if stock.quantitat > 0 %}
                                <input type="radio" class="btn-check" name="stock_id" id="stock{{ stock.id }}" value="{{ stock.id }}" required>
                                <label class="btn btn-outline-primary" for="stock{{ stock.id }}">{{ stock.talla.n_talla }}</label>
                            {% else %}
                                <input type="radio" class="btn-check" disabled>
                                <label class="btn btn-outline-secondary disabled">{{ stock.talla.n_talla }} (No disponible)</label>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- 🔢 Selector de quantitat -->
                    <div class="mb-3">
                        <label for="quantitat">Quantitat:</label>
                        <input type="number" class="form-control" id="quantitat" name="quantitat" value="1" min="1" required>
                    </div>

                    <!-- 🛒 Botón añadir al carrito -->
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-cart-plus"></i> Afegir a la cistella
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>



<!-- 📜 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function changeImage(event, src) {
        document.getElementById('mainImage').src = src;
        document.querySelectorAll('.variant-thumbnail').forEach(thumb => thumb.classList.remove('active'));
        event.target.classList.add('active');
    }

    function changeVariant(event, variantId) {
        event.preventDefault();

        fetch(`/producte/variant/${variantId}/`)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");

                // 🔄 Actualizar imagen principal
                document.querySelector("#mainImage").src = doc.querySelector("#mainImage").src;

                // 🔄 Actualizar miniaturas de imágenes
                document.querySelector(".d-flex.flex-wrap").innerHTML = doc.querySelector(".d-flex.flex-wrap").innerHTML;

                // 🔄 Actualizar precio y descuento
                document.querySelector("#newPrice").textContent = doc.querySelector("#newPrice").textContent;
                document.querySelector("#oldPrice").textContent = doc.querySelector("#oldPrice").textContent;
                document.querySelector("#discount").textContent = doc.querySelector("#discount").textContent;

                // 🔄 Actualizar tallas disponibles
                document.querySelector(".talla-container").innerHTML = doc.querySelector(".talla-container").innerHTML;

                // 🔄 Resaltar la variante seleccionada
                document.querySelectorAll('.variant-thumbnail').forEach(img => img.classList.remove('active'));
                event.target.classList.add('active');
            });
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".variant-thumbnail").forEach(thumb => {
            thumb.addEventListener("click", function (event) {
                const variantId = this.dataset.variantId;
                changeVariant(event, variantId);
            });
        });
    });
</script>

{% endblock %}
